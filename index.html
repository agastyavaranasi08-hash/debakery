<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wearable Biosensor Smart T‑Shirt — Device Dashboard</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#111823;--muted:#1a2431;--card:#0f1620;--accent:#4f9cff;--accent-2:#22d3ee;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444;--text:#e6eef7;--text-dim:#b8c4d4;--border:#223044;--shadow:0 10px 25px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:linear-gradient(180deg, #0b0f14 0%, #0d1420 100%);color:var(--text)}
    header{position:sticky;top:0;z-index:20;background:rgba(15,22,32,.9);backdrop-filter: blur(8px);border-bottom:1px solid var(--border)}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 18px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:34px;height:34px;border-radius:10px;background:conic-gradient(from 200deg at 50% 50%, var(--accent), var(--accent-2));box-shadow:0 0 0 2px #0b1220 inset}
    .brand h1{margin:0;font-size:16px;letter-spacing:.2px;color:#eaf2ff}
    .actions{display:flex;gap:8px}
    button,.btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#182234,#121a27);color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer;transition:.2s ease;box-shadow:var(--shadow)}
    button:hover,.btn:hover{transform:translateY(-1px);border-color:#2a3b55}
    .btn.primary{background:linear-gradient(180deg, #2a66ff, #1643b7);border-color:#2a66ff}
    .btn.ghost{background:transparent}

    .layout{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 58px)}
    aside{border-right:1px solid var(--border);background:linear-gradient(180deg,#0c121b,#0b1017);padding:16px}
    main{padding:18px}

    .panel{background:linear-gradient(180deg,#0e1520,#0b121b);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .panel h3{margin:0 0 10px 0;font-size:13px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-dim)}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-top:14px}
    .kpi{padding:14px;border:1px solid var(--border);background:linear-gradient(180deg,#0f1622,#0c121a);border-radius:16px}
    .kpi .label{font-size:12px;color:var(--text-dim)}
    .kpi .value{font-size:24px;margin-top:6px}
    .kpi .unit{font-size:12px;color:var(--text-dim)}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:14px}
    .card{padding:14px;border:1px solid var(--border);background:linear-gradient(180deg,#111a28,#0b121b);border-radius:16px}

    .status{display:grid;gap:10px}
    .badge{display:inline-flex;align-items:center;gap:8px;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:linear-gradient(180deg,#131d2a,#0e1622)}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--text-dim)}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .controls{display:grid;gap:10px;margin-top:12px}
    .control{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border:1px dashed #26344a;border-radius:12px}
    .switch{position:relative;width:48px;height:28px;display:inline-block}
    .switch input{display:none}
    .slider{position:absolute;cursor:pointer;inset:0;background:#233247;border:1px solid #2a3a56;border-radius:999px;transition:.2s}
    .slider:before{content:"";position:absolute;height:20px;width:20px;left:4px;top:3px;background:white;border-radius:50%;transition:.2s}
    input:checked + .slider{background:linear-gradient(180deg,#22d3ee,#1994ff)}
    input:checked + .slider:before{transform:translateX(20px)}

    .range{width:160px}
    input[type="range"]{width:100%}

    canvas{width:100%;height:220px;background:#0a111a;border-radius:12px;border:1px solid #1c2a3f}

    .tabs{display:flex;gap:6px;border-bottom:1px solid var(--border);padding:0 6px}
    .tab{padding:10px 12px;border-top-left-radius:12px;border-top-right-radius:12px;border:1px solid transparent;cursor:pointer;color:var(--text-dim)}
    .tab.active{border-color:var(--border);border-bottom-color:transparent;background:linear-gradient(180deg,#122033,#0c141f);color:var(--text)}

    .tabpanes > section{display:none}
    .tabpanes > section.active{display:block}

    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    details{border:1px solid var(--border);border-radius:12px;padding:12px;background:linear-gradient(180deg,#0f1724,#0b121b)}
    details summary{cursor:pointer;color:#d6e4ff}

    .table-wrap{max-height:280px;overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #23334a}
    th{position:sticky;top:0;background:#0d1623;text-align:left;font-size:12px;color:var(--text-dim)}
    tr:hover td{background:#0f1a2a}

    .toast{position:fixed;right:16px;bottom:16px;background:linear-gradient(180deg,#0e1826,#0c1522);border:1px solid var(--border);padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);display:none}
    .toast.show{display:block}

    .footer{margin-top:14px;font-size:12px;color:var(--text-dim)}
    .search{display:flex;gap:8px}
    input[type="text"], select{background:#0f1724;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px}
    input[type="number"]{width:90px;background:#0f1724;border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:8px}
    .muted{color:var(--text-dim)}

    @media (max-width:1024px){
      .layout{grid-template-columns:1fr}
      aside{order:2}
      .grid{grid-template-columns:1fr}
      .kpis{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Smart T‑Shirt • Device Dashboard</h1>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnConnect">Connect</button>
        <button class="btn" id="btnStart">Start Stream</button>
        <button class="btn" id="btnStop" disabled>Stop</button>
        <button class="btn primary" id="btnExport">Export CSV</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside>
      <div class="panel" style="padding:14px">
        <h3>Device Status</h3>
        <div class="status">
          <div class="badge"><span class="dot" id="dotConn"></span> Connection: <strong id="connLabel">Disconnected</strong></div>
          <div class="badge"><span class="dot good"></span> Battery: <strong id="batt">92%</strong></div>
          <div class="badge"><span class="dot good"></span> Firmware: <strong>v0.9.3</strong></div>
          <div class="badge"><span class="dot good"></span> BLE Mode: <strong id="bleMode">BLE</strong></div>
        </div>
      </div>

      <div class="panel" style="padding:14px;margin-top:14px">
        <h3>Thresholds</h3>
        <div class="controls">
          <div class="control"><label>Heart Rate Max</label><input id="thrHR" type="number" value="170"> bpm</div>
          <div class="control"><label>Skin Temp Max</label><input id="thrTemp" type="number" value="39.0"> °C</div>
          <div class="control"><label>EDA Max</label><input id="thrEDA" type="number" value="8.0"> µS</div>
          <div class="control"><label>Resp Rate Max</label><input id="thrResp" type="number" value="30"> brpm</div>
          <button id="savePrefs" class="btn">Save Preferences</button>
        </div>
      </div>
    </aside>

    <main>
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="dash" role="tab" aria-selected="true">Dashboard</div>
        <div class="tab" data-tab="manage" role="tab">Manage</div>
        <div class="tab" data-tab="data" role="tab">Data</div>
        <div class="tab" data-tab="docs" role="tab">Project Write‑Up</div>
      </div>

      <div class="tabpanes">
        <!-- DASHBOARD -->
        <section id="tab-dash" class="active" aria-label="Dashboard">
          <div class="kpis">
            <div class="kpi"><div class="label">Heart Rate</div><div class="value"><span id="kpiHR">—</span> <span class="unit">bpm</span></div></div>
            <div class="kpi"><div class="label">Skin Temp</div><div class="value"><span id="kpiTemp">—</span> <span class="unit">°C</span></div></div>
            <div class="kpi"><div class="label">Resp Rate</div><div class="value"><span id="kpiResp">—</span> <span class="unit">brpm</span></div></div>
            <div class="kpi"><div class="label">EDA</div><div class="value"><span id="kpiEDA">—</span> <span class="unit">µS</span></div></div>
          </div>

          <div class="grid">
            <div class="card">
              <header style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                <strong>Live Signals</strong>
                <div class="search">
                  <input id="timeWindow" type="number" min="10" max="600" value="120" />
                  <span class="muted">sec window</span>
                </div>
              </header>
              <canvas id="chart"></canvas>
            </div>
            <div class="card">
              <strong>Alerts</strong>
              <div id="alerts" class="status" style="margin-top:8px"></div>
            </div>
          </div>
        </section>

        <!-- MANAGE -->
        <section id="tab-manage" aria-label="Manage">
          <div class="two-col">
            <div class="card">
              <strong>Device Controls</strong>
              <div class="controls" style="margin-top:8px">
                <div class="control"><label>Operating Mode</label>
                  <select id="mode">
                    <option value="normal">Normal</option>
                    <option value="lowpower">Low Power</option>
                    <option value="lab">Lab (High Rate)</option>
                  </select>
                </div>
                <div class="control"><label>BLE Profile</label>
                  <select id="ble">
                    <option value="BLE">BLE</option>
                    <option value="BLE-LR">BLE‑LR</option>
                    <option value="USB">USB (Dock)</option>
                  </select>
                </div>
                <div class="control"><label>Buffer Length</label><input id="buffer" type="number" value="30"> sec</div>
                <div class="control"><label>Vibration Alerts</label>
                  <label class="switch"><input id="vibe" type="checkbox" checked><span class="slider"></span></label>
                </div>
                <button class="btn" id="apply">Apply Settings</button>
              </div>
            </div>
            <div class="card">
              <strong>User & Access</strong>
              <div class="controls" style="margin-top:8px">
                <div class="control"><label>Assign Wearer</label><input id="wearer" type="text" placeholder="e.g. A. Patel"/></div>
                <div class="control"><label>Clinician Email</label><input id="clinician" type="text" placeholder="name@hospital.org"/></div>
                <div class="control"><label>Share Link (read‑only)</label><input id="share" type="text" readonly value="https://example.app/s/XYZ123"/></div>
                <button class="btn" id="invite">Send Invite</button>
              </div>
            </div>
          </div>
        </section>

        <!-- DATA -->
        <section id="tab-data" aria-label="Data">
          <div class="card">
            <header style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
              <strong>Session Log</strong>
              <div class="search">
                <input id="filter" type="text" placeholder="Filter (e.g. alert, >160)"/>
                <button class="btn" id="clearLog">Clear</button>
              </div>
            </header>
            <div class="table-wrap">
              <table id="logTable" aria-label="Log table">
                <thead><tr><th>Time</th><th>Heart Rate</th><th>Temp (°C)</th><th>Resp (brpm)</th><th>EDA (µS)</th><th>Notes</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- DOCS / WRITE-UP -->
        <section id="tab-docs" aria-label="Docs">
          <div class="two-col">
            <div class="card">
              <details open>
                <summary><strong>Purpose & Rationale</strong></summary>
                <p>We chose the topic of wearable biosensors and smart clothing because it combines our interests in technology and healthcare while aligning with our goal of pursuing a career in health science. We’re inspired by how smart clothing can transform patient care by providing continuous, real-time monitoring of vital signs and stress levels, allowing for earlier detection and prevention of disease. This technology not only bridges innovation and medicine but also holds global importance by making healthcare more accessible, especially in areas with limited medical resources. It represents a major step toward preventive, data-driven, and equitable healthcare worldwide.</p>
              </details>
              <details>
                <summary><strong>Abstract & Introduction</strong></summary>
                <p>Wearable biosensors have increased. Continuous vital sign monitoring outside of clinical settings. Modern sensors can record heart rate and heart rhythm, blood oxygen saturation, blood pressure, respiration rate, body temperature, and more. The American Association of Clinical Endocrinologists also explains how continuous glucose monitors such as the “Abbott” series can track blood glucose levels without need for invasive procedures like finger sticks while also providing alerts/alarms to improve safety and quality of life for diabetic patients (CGM Device Comparison, n.d.). Other examples include the Hexoskin smart shirt which can measure heart rate, breathing rate, and sleep (Hexoskin, 2025).
                </p>
                <p>These technologies have origins in the 20th century. Sensors and recording devices were used in hospitals and medical settings to accurately measure patient status and improve quality of care, however these were bulky and couldn’t be moved. As technology progressed and materials, microelectronics, and technology became more advanced, medical technologies began becoming more accessible. The American Heart Association states that development and use of the holter monitor first began in the 1940s, allowing for long term cardiac monitoring portably for the first time (Zimetbaum, 2010). The original holter monitor was 75-lb but it could record an ECG lead for several hours. The American Heart Association describes how this development of ambulatory monitoring allows for physicians to better address disorders and potential cardiac risks (Zimetbaum, 2010). Nowadays there are even rings, shirts, and watches that can perform similar functions.</p>
                <p>These technologies allow for more personalized care as patients can easily record accurate data about their daily life. This allows clinicians to see insights in individual circumstances and patterns. This allows for individual patient indicators to be identified early on and addressed. NIH demonstrates how increased quality of life for individuals such as diabetes patients as they avoid the invasive measures usually necessary for monitoring glucose. In addition technologies the NIH describes how technologies such as CGMs allow for more efficient and tailored care as they are able to continually maintain glucose levels.</p>
              </details>
              <details>
                <summary><strong>Health Problem or Need</strong></summary>
                <p>A major need/use case in the current world for biosensors is that outdoor workers and student athletes often experience preventable heat-related illness because early physiologic signs are not continuously monitored in real time (according to NIOSH, 2016). To solve this, we need an affordable, washable smart garment that passively tracks multi-modal biosignals (skin temperature, heart rate/HRV, respiration, sweat/EDA, activity) and delivers immediate alerts to the wearer and supervisor to prompt hydration, rest, and cooling, thus reducing incidents, ER visits, and time lost (according to Roberts et al., 2023; Smith et al., 2019).</p>
              </details>
            </div>
            <div class="card">
              <details open>
                <summary><strong>Technology Description</strong></summary>
                <p>The key components of our technology are the sensing layer, data acquisition module, power and communications, and software analytics. First, our sensing layer contains silver-coated yarn electrodes integrated at chest zones to capture single-lead ECG, encapsulated to preserve washability (Heikenfeld et al.). Strain sensors are placed across the chest and abdomen to measure respiratory rate (Ates et al.). Finally, a miniaturized electrochemical cell placed in a sweat-prone area (underarm or chest) measures cortisol levels via an immunoassay or aptamer-based recognition coupled to an amperometric transducer (Kim et al.).</p>
                <p>Our data acquisition & conditioning module includes a low-noise analog front end (ECG amplifier, anti-alias filters), ADCs, microcontroller with BLE and local buffering (Stoppa & Chioleri). The wearable biosensor boasts a rechargeable thin battery in a small detachable module (clips on/off for washing) for extended use (Heikenfeld et al.). It is connected to a BLE or BLE-LR for secure streaming to the patient’s phone, or to onboard storage if offline (Heikenfeld et al.).</p>
                <p>The software for analysis of collected data is top notch, comprising real-time signal processing that covers ECG R-peak detection, HR and HRV computation, respiratory cycle detection, and sweat sensing, extracting key features such as heart rate and respiration from raw signals (Heikenfeld et al., 2018). We incorporate a machine-learning model to combine modalities into stress index and CVD-risk alerts (Kim et al.). Finally, the patients will receive a secure cloud dashboard for clinicians and user feedback loops (Ates et al.; Stoppa & Chiolerio).</p>
              </details>
              <details>
                <summary><strong>Research Question</strong></summary>
                <p>How effectively can a smart T-shirt embedded with multi-modal biosensors (ECG, respiratory, EDA, and temperature) monitor and interpret continuous vital signs and stress levels in real-world conditions compared to standard clinical instruments?</p>
              </details>
              <details>
                <summary><strong>Conclusion</strong></summary>
                <p>Wearable biosensors reflect the essence of global health innovation as it uses technology to make healthcare more accessible, proactive, and equitable. In low-resource settings, affordable smart clothing could allow remote monitoring where clinics are scarce, bridging gaps in medical infrastructure. This connects deeply with my view that the future of medicine lies in decentralizing care by bringing diagnostic and monitoring capabilities to the individual, rather than waiting for the individual to reach the clinic. Just as my earlier research on space herbiculture explored sustainability in isolated environments, wearable biosensors explore sustainability in healthcare: empowering people everywhere, regardless of geography or resources, to take charge of their own health.</p>
              </details>
            </div>
          </div>
        </section>
      </div>

      <div class="footer">Mock data only. No PHI stored. Settings persist in this browser via localStorage.</div>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ====== Utilities ======
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmtTime = d => new Date(d).toLocaleTimeString();

    // ====== State ======
    const state = {
      connected:false, running:false,
      interval:null, hz:5, windowSec:120,
      thresholds:{hr:170,temp:39,eda:8,resp:30},
      log:[],
    };

    // Load persisted prefs
    (function loadPrefs(){
      try{
        const p = JSON.parse(localStorage.getItem('prefs')||'{}');
        if(p.thresholds){ state.thresholds = p.thresholds; }
        if(p.hz){ state.hz = p.hz; }
        if(p.windowSec){ state.windowSec = p.windowSec; }
        // reflect
        $('#thrHR').value = state.thresholds.hr;
        $('#thrTemp').value = state.thresholds.temp;
        $('#thrEDA').value = state.thresholds.eda;
        $('#thrResp').value = state.thresholds.resp;
        $('#sampleHz').value = state.hz;
        $('#timeWindow').value = state.windowSec;
      }catch(e){}
    })();

    // ====== Tabs ======
    $$('.tab').forEach(t=>t.addEventListener('click',()=>{
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const id = t.dataset.tab;
      $$('.tabpanes > section').forEach(s=>s.classList.remove('active'));
      $('#tab-'+id).classList.add('active');
    }));

    // ====== Toast ======
    function toast(msg, ms=2000){
      const t = $('#toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), ms);
    }

    // ====== Device Connect/Start/Stop ======
    $('#btnConnect').addEventListener('click',()=>{
      state.connected = !state.connected;
      $('#connLabel').textContent = state.connected? 'Connected' : 'Disconnected';
      $('#dotConn').className = 'dot ' + (state.connected? 'good':'');
      toast(state.connected? 'Device connected' : 'Device disconnected');
    });

    $('#btnStart').addEventListener('click',()=>{
      if(!state.connected){ toast('Connect to device first'); return; }
      startStream();
    });
    $('#btnStop').addEventListener('click', stopStream);

    function startStream(){
      if(state.running) return;
      state.running = true;
      $('#btnStart').disabled = true; $('#btnStop').disabled = false;
      const dt = 1000/Math.max(1, +$('#sampleHz').value || state.hz);
      state.hz = 1000/dt;
      state.interval = setInterval(tick, dt);
      toast('Streaming started');
    }
    function stopStream(){
      state.running = false; clearInterval(state.interval);
      $('#btnStart').disabled = false; $('#btnStop').disabled = true;
      toast('Streaming stopped');
    }

    // ====== Preferences ======
    $('#savePrefs').addEventListener('click',()=>{
      state.thresholds = {
        hr:+$('#thrHR').value, temp:+$('#thrTemp').value,
        eda:+$('#thrEDA').value, resp:+$('#thrResp').value
      };
      state.hz = +$('#sampleHz').value;
      state.windowSec = +$('#timeWindow').value;
      localStorage.setItem('prefs', JSON.stringify({thresholds:state.thresholds,hz:state.hz,windowSec:state.windowSec}));
      toast('Preferences saved');
    });

    // ====== Apply/Invite ======
    $('#apply').addEventListener('click',()=>toast('Device settings applied'));
    $('#invite').addEventListener('click',()=>toast('Invitation sent to clinician'));

    // ====== Export CSV ======
    $('#btnExport').addEventListener('click',()=>{
      if(!state.log.length){ toast('No data to export'); return; }
      const headers = ['time','hr','temp','resp','eda','note'];
      const rows = state.log.map(r=>[r.t, r.hr.toFixed(0), r.temp.toFixed(2), r.resp.toFixed(0), r.eda.toFixed(2), r.note||'']);
      const csv = [headers.join(','), ...rows.map(r=>r.join(','))].join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'session.csv'; a.click(); URL.revokeObjectURL(a.href);
      toast('CSV exported');
    });

    // ====== Filter/Clear Log ======
    $('#filter').addEventListener('input', renderLog);
    $('#clearLog').addEventListener('click',()=>{state.log=[]; renderLog(); toast('Log cleared')});

    // ====== Data Generation & Chart ======
    const ctx = $('#chart').getContext('2d');
    const series = {hr:[], temp:[], resp:[], eda:[], time:[]};

    function tick(){
      const now = Date.now();
      // toy physiology-ish signals
      const t = now/1000;
      const hr = 78 + 10*Math.sin(t/3) + randn()*2; // bpm
      const temp = 36.6 + 0.3*Math.sin(t/60) + randn()*0.02; // °C
      const resp = 14 + 2*Math.sin(t/5) + randn()*0.6; // brpm
      const eda = 2.0 + 0.5*Math.sin(t/9) + Math.abs(randn()*0.1); // µS

      // occasional heat stress spike simulation
      if(Math.random()<0.01){
        series.hr.push(160+Math.random()*15);
        series.temp.push(38.8+Math.random()*0.6);
        series.resp.push(28+Math.random()*6);
        series.eda.push(6+Math.random()*2);
      } else {
        series.hr.push(hr);
        series.temp.push(temp);
        series.resp.push(resp);
        series.eda.push(eda);
      }
      series.time.push(now);

      // windowing
      const maxLen = Math.max(10, state.windowSec * state.hz);
      Object.keys(series).forEach(k=>{ while(series[k].length>maxLen) series[k].shift(); });

      // KPIs
      $('#kpiHR').textContent = series.hr.at(-1).toFixed(0);
      $('#kpiTemp').textContent = series.temp.at(-1).toFixed(2);
      $('#kpiResp').textContent = series.resp.at(-1).toFixed(0);
      $('#kpiEDA').textContent = series.eda.at(-1).toFixed(2);

      // Alerts & Log
      checkAlerts(now);
      appendLog(now, series);

      // Draw chart
      drawChart();
    }

    function randn(){ // Gaussian-ish
      let u=0,v=0; while(u===0)u=Math.random(); while(v===0)v=Math.random();
      return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
    }

    function checkAlerts(ts){
      const a = $('#alerts');
      const notes = [];
      const hr=series.hr.at(-1), temp=series.temp.at(-1), eda=series.eda.at(-1), resp=series.resp.at(-1);
      a.innerHTML='';
      function add(msg, kind='warn'){ const div=document.createElement('div'); div.className='badge'; const dot=document.createElement('span'); dot.className='dot '+(kind==='bad'?'bad':'warn'); div.appendChild(dot); div.appendChild(document.createTextNode(' '+msg)); a.appendChild(div); notes.push(msg); }
      if(hr>state.thresholds.hr) add(`High HR ${hr.toFixed(0)} bpm`, 'bad');
      if(temp>state.thresholds.temp) add(`High Temp ${temp.toFixed(1)}°C`, 'bad');
      if(eda>state.thresholds.eda) add(`High EDA ${eda.toFixed(2)} µS`, 'warn');
      if(resp>state.thresholds.resp) add(`High Resp ${resp.toFixed(0)} brpm`, 'warn');
      state._notes = notes.join(' | ');
      if(notes.length) {
        // optional: play a quiet beep proportional to volume
        const vol = +$('#alertVol').value; if(vol>0) beep(vol/200);
      }
    }

    function appendLog(ts){
      const row = { t: new Date(ts).toISOString(), hr: series.hr.at(-1), temp: series.temp.at(-1), resp: series.resp.at(-1), eda: series.eda.at(-1), note: state._notes };
      state.log.push(row);
      // cap log to reasonable size
      if(state.log.length>2000) state.log.shift();
      if($('#tab-data').classList.contains('active')) renderLog();
      else if(state.log.length%10===0) renderLog(); // occasional refresh
    }

    function renderLog(){
      const tbody = $('#logTable tbody');
      const q = ($('#filter').value||'').trim();
      const rows = q? state.log.filter(r=> JSON.stringify(r).toLowerCase().includes(q.toLowerCase())) : state.log;
      tbody.innerHTML = rows.slice(-1000).map(r=>`<tr><td>${fmtTime(r.t)}</td><td>${r.hr.toFixed(0)}</td><td>${r.temp.toFixed(2)}</td><td>${r.resp.toFixed(0)}</td><td>${r.eda.toFixed(2)}</td><td>${r.note||''}</td></tr>`).join('');
    }

    function drawChart(){
      const w = ctx.canvas.clientWidth, h = ctx.canvas.clientHeight;
      ctx.canvas.width = w * devicePixelRatio; ctx.canvas.height = h * devicePixelRatio; ctx.scale(devicePixelRatio, devicePixelRatio);
      ctx.clearRect(0,0,w,h);
      // axes
      ctx.strokeStyle = '#203049'; ctx.lineWidth = 1; ctx.beginPath();
      for(let y=0;y<h;y+=28){ ctx.moveTo(0,y+.5); ctx.lineTo(w,y+.5);} ctx.stroke();
      // helpers
      function plot(arr, color, yMin, yMax){
        if(arr.length<2) return; ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
        const n = arr.length; for(let i=0;i<n;i++){
          const x = (i/(n-1))*w; const y = h - ((arr[i]-yMin)/(yMax-yMin))*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        } ctx.stroke();
      }
      plot(series.hr, '#7dd3fc', 50, 190);
      plot(series.temp, '#a5b4fc', 35, 40.5);
      plot(series.resp, '#86efac', 8, 36);
      plot(series.eda, '#fca5a5', 0, 10);
      // legend
      const items = [ ['HR','\u25A0','#7dd3fc'], ['Temp','\u25A0','#a5b4fc'], ['Resp','\u25A0','#86efac'], ['EDA','\u25A0','#fca5a5'] ];
      ctx.fillStyle = '#c8d4e8'; ctx.font = '12px Inter, sans-serif';
      items.forEach((it,i)=>{ ctx.fillStyle = it[2]; ctx.fillRect(10+i*90,10,10,10); ctx.fillStyle='#c8d4e8'; ctx.fillText(' '+it[0], 22+i*90, 20); });
    }

    // simple beep using WebAudio
    let audioCtx; function beep(vol=0.2){ try{ audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sine'; o.frequency.value = 880; o.connect(g); g.connect(audioCtx.destination); g.gain.value=vol; o.start(); setTimeout(()=>{o.stop();}, 120);}catch(e){} }

    // Init first render
    renderLog(); drawChart();
  </script>
</body>
</html>
